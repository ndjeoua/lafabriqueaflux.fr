---
import { Image } from "astro:assets";
import Button from "../../shared/Button.astro";

// Define TypeScript interfaces
interface ContactInfo {
  heading: string;
  address?: string;
  cell?: string;
  email?: string;
  image?: string;
  image_alt?: string;
}

interface FormField {
  heading: string;
  placeholder: string;
}

interface SubmitButton {
  text: string;
}

interface ContactForm {
  heading: string;
  fullname: FormField;
  phone_number: FormField;
  email: FormField;
  message: FormField;
  submit_button: SubmitButton;
}

interface Props {
  address?: ContactInfo;
  phone?: ContactInfo;
  email?: ContactInfo;
  form?: ContactForm;
}


const { address, phone, email, form } = Astro.props;
---

<section class="mb-20">
  <div class="bg-primary/10 bg-linear-to-b from-cyan-primary/10 to-white lg:h-60 -z-30 relative "></div>
  <div class="max-w-7xl pt-10 mx-auto px-4 sm:px-6 lg:px-8">
    <div class="grid lg:grid-cols-12 gap-8 lg:gap-16">
      <!-- Contact Information -->
      <div class="lg:col-span-5 order-1 lg:-mt-30">
        <div class="space-y-8">
          {address && (
            <div class="space-y-2">
              <h3 class="text-xl font-semibold text-gray-900">
                {address.heading}
              </h3>
              <p 
                class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
              >
                <Image
                 
                 
                 
                  src={address.image || "/images/default-address.png"}
                  alt={address.image_alt || "Address icon"}
                  loading="lazy"
                  width={24}
                  height={24}
                  class="w-6 h-6"
                />
                {address.address}
              </p>
            </div>
          )}
          
          {phone && (
            <div class="space-y-2">
              <h3 class="text-xl font-semibold text-gray-900">
                {phone.heading}
              </h3>
              <a 
                href={`tel:${phone.cell}`}
                class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
              >
                <Image
                 
                 
                 
                  src={phone.image || "/images/default-phone.png"}
                  alt={phone.image_alt || "Phone icon"}
                  loading="lazy"
                  width={24}
                  height={24}
                  class="w-6 h-6"
                />
                {phone.cell}
              </a>
            </div>
          )}
          
          {email && (
            <div class="space-y-2">
              <h3 class="text-xl font-semibold text-gray-900">
                {email.heading}
              </h3>
              <a 
                href={`mailto:${email.email}`}
                class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 transition-colors"
              >
                <Image
                 
                 
                 
                  src={email.image || "/images/default-email.png"}
                  alt={email.image_alt || "Email icon"}
                  loading="lazy"
                  width={24}
                  height={24}
                  class="w-6 h-6"
                />
                {email.email}
              </a>
            </div>
          )}
        </div>
      </div>

      <!-- Contact Form -->
      <div class="lg:col-span-7 order-1 lg:order-2 lg:-mt-50">
        {form && (
          <div class="relative bg-white rounded-2xl p-8 shadow-lg border border-gray-100">
            <div 
              class="absolute -top-[10%] -z-10 -left-[14%] w-[115%] h-full bg-primary/30"
              style="mask-image: url(/images/contact/effects.png); -webkit-mask-image: url(/images/contact/effects.png); mask-repeat: no-repeat; -webkit-mask-repeat: no-repeat; mask-size: contain; -webkit-mask-size: contain;"
            ></div>
            <form id="contact-form" class="space-y-6">
              <h3 class="text-2xl font-bold text-gray-900 mb-8">
                {form.heading}
              </h3>
              
              <div id="form-message" class="hidden p-4 rounded-lg text-sm font-medium"></div>

              {form.fullname && (
                <div class="space-y-2">
                  <label for="full_name" class="block text-sm font-medium text-gray-700">
                    {form.fullname.heading}
                  </label>
                  <input 
                    type="text" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    id="full_name" 
                    name="full_name" 
                    placeholder={form.fullname.placeholder} 
                    required 
                  />
                </div>
              )}

              {form.phone_number && (
                <div class="space-y-2">
                  <label for="company" class="block text-sm font-medium text-gray-700">
                    {form.phone_number.heading}
                  </label>
                  <input
                    type="text"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                    id="company"
                    name="company"
                    placeholder={form.phone_number.placeholder}
                    required
                  />
                </div>
              )}

              {form.email && (
                <div class="space-y-2">
                  <label for="email" class="block text-sm font-medium text-gray-700">
                    {form.email.heading}
                  </label>
                  <input 
                    type="email" 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors" 
                    id="email" 
                    name="email" 
                    placeholder={form.email.placeholder} 
                    required 
                  />
                </div>
              )}

              {form.message && (
                <div class="space-y-2">
                  <label for="message" class="block text-sm font-medium text-gray-700">
                    {form.message.heading}
                  </label>
                  <textarea
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors resize-vertical"
                    id="message"
                    name="message"
                    placeholder={form.message.placeholder}
                    rows="6"
                    spellcheck="false"
                  ></textarea>
                </div>
              )}

              <!-- Honeypot field -->
              <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />

              {form.submit_button && (
                <div class="pt-4">
                  <Button
                    type="submit"
                    id="submit-btn"
                    variant="primary"
                    size="lg"
                    text={form.submit_button.text}
                   
                   
                    class="w-full sm:w-auto"
                  />
                </div>
              )}
            </form>

            <script is:inline>
              const form = document.getElementById('contact-form');
              const messageDiv = document.getElementById('form-message');
              const submitBtn = document.getElementById('submit-btn');

              // URL N8N RÉELLE
              const N8N_WEBHOOK_URL = 'https://ai-video-factory.duckdns.org/webhook-test/contact'; 
              const FORM_TOKEN = 'LFF_SECRET_TOKEN_2024';

              if (form) {
                form.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  
                  // Reset states
                  messageDiv.classList.add('hidden');
                  submitBtn.disabled = true;
                  const originalBtnText = submitBtn.innerText;
                  submitBtn.innerText = 'Envoi en cours...';

                  const formData = new FormData(form);
                  
                  // Ajout des métadonnées directement dans FormData
                  formData.append('source', 'lafabriqueaflux.fr');
                  formData.append('page_url', window.location.href);
                  formData.append('user_agent', navigator.userAgent);
                  formData.append('submitted_at', new Date().toISOString());
                  formData.append('form_token', FORM_TOKEN);

                  try {
                    // Utilisation de multipart/form-data (natif) pour éviter les preflight CORS
                    const response = await fetch(N8N_WEBHOOK_URL, {
                      method: 'POST',
                      body: formData
                    });

                    if (response.ok) {
                      messageDiv.innerText = 'Merci, votre demande a bien été envoyée ! Nous revenons vers vous rapidement.';
                      messageDiv.classList.remove('hidden', 'bg-red-50', 'text-red-800');
                      messageDiv.classList.add('bg-green-50', 'text-green-800');
                      form.reset();
                    } else {
                      const errorData = await response.text();
                      console.error('Erreur n8n:', errorData);
                      throw new Error('Erreur serveur');
                    }
                  } catch (error) {
                    console.error('Erreur réseau:', error);
                    messageDiv.innerText = "Connexion à n8n impossible. Vérifiez que votre Webhook est bien en mode 'Listen' dans n8n, ou contactez-nous à contact@lafabriqueaflux.fr";
                    messageDiv.classList.remove('hidden', 'bg-green-50', 'text-green-800');
                    messageDiv.classList.add('bg-red-50', 'text-red-800');
                  } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalBtnText;
                  }
                });
              }
            </script>
            
          </div>
        )}
      </div>
    </div>
  </div>
</section>
